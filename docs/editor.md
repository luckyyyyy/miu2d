# 🎮 Miu2D Engine 游戏编辑器规划

## 一、编辑器总览

根据现有引擎功能，建议开发 **12 类编辑器**，按优先级分为 3 个阶段：

| 阶段 | 编辑器 | 优先级 | 复杂度 |
|:----:|--------|:------:|:------:|
| **P0** | 🗺️ 地图编辑器 | ⭐⭐⭐⭐⭐ | 高 |
| **P0** | 📜 脚本编辑器 | ⭐⭐⭐⭐⭐ | 中 |
| **P0** | 🧙 武功编辑器 | ⭐⭐⭐⭐ | 中 |
| **P1** | 👤 NPC/怪物编辑器 | ⭐⭐⭐⭐ | 中 |
| **P1** | 🎒 物品编辑器 | ⭐⭐⭐ | 低 |
| **P1** | 🏪 商店编辑器 | ⭐⭐ | 低 |
| **P1** | 📦 场景物体编辑器 | ⭐⭐⭐ | 低 |
| **P2** | 👤 玩家/伙伴编辑器 | ⭐⭐⭐ | 中 |
| **P2** | 📊 等级平衡编辑器 | ⭐⭐⭐ | 低 |
| **P2** | 🎬 精灵asf编辑器 | ⭐⭐⭐ | 中 |
| **P2** | 🔊 音频管理器 | ⭐⭐ | 低 |
| **P2** | 💾 存档编辑器 | ⭐⭐⭐ | 中 |

---

## 二、P0 核心编辑器（必须优先开发）

### 1. 🗺️ 地图编辑器

**功能需求：**

| 模块 | 功能 | 说明 |
|------|------|------|
| **地图查看** | 三层瓦片可视化 | Layer1(地面) + Layer2(装饰) + Layer3(遮挡) |
| **障碍编辑** | 绘制/擦除障碍物 | `0x00`=无, `0x80`=完全阻挡, `0x40`=透明阻挡, `0x20`=可跳跃 |
| **陷阱编辑** | 设置陷阱触发区域 | 绑定脚本文件路径 |
| **MPC 管理** | 瓦片资源预览 | 查看/替换 MPC 瓦片 |
| **NPC 布局** | 放置 NPC 起始位置 | 拖拽设置 NPC 初始坐标和朝向 |
| **物体布局** | 放置 Obj 位置 | 宝箱、草药、装饰物等 |
| **测试运行** | 快速进入地图测试 | 设置玩家出生点后启动游戏 |

**数据格式：**
```
resources/map/{map_name}.map          # 二进制地图文件
resources/mpc/map/{map_name}/*.mpc    # 瓦片资源包
resources/ini/map/{map_name}.npc      # NPC 配置
resources/ini/map/{map_name}.obj      # 物体配置
resources/script/map/{map_name}/      # 地图脚本目录
```

**界面布局：**
```
┌─────────────────────────────────────────────────────────────┐
│ [工具栏] 选择 | 障碍画笔 | 陷阱画笔 | NPC | Obj | 测试     │
├──────────────────────────────────┬──────────────────────────┤
│                                  │ 📁 图层面板              │
│                                  │ ├─ ☑ Layer1 (地面)       │
│                                  │ ├─ ☑ Layer2 (装饰)       │
│          地图画布                │ ├─ ☑ Layer3 (遮挡)       │
│        (WebGL 渲染)              │ └─ ☑ 障碍层              │
│                                  ├──────────────────────────┤
│                                  │ 🔧 属性面板              │
│                                  │ ├─ 选中瓦片信息          │
│                                  │ ├─ 障碍类型选择          │
│                                  │ └─ 陷阱脚本绑定          │
├──────────────────────────────────┴──────────────────────────┤
│ [状态栏] 坐标: (24, 35) | 瓦片: (12, 8) | 缩放: 100%        │
└─────────────────────────────────────────────────────────────┘
```

---

### 2. 📜 脚本编辑器

**功能需求：**

| 模块 | 功能 | 说明 |
|------|------|------|
| **语法高亮** | 命令、参数、注释着色 | 命令名 (蓝)、字符串 (绿)、变量 (橙)、注释 (灰) |
| **自动补全** | 命令和参数提示 | 150+ 命令的智能补全 |
| **参数提示** | 命令签名文档 | 悬停显示参数类型和说明 |
| **语法检查** | 实时错误提示 | 命令拼写、参数数量校验 |
| **变量追踪** | 显示脚本变量 | `$Event`, `$SubEvent01` 等变量列表 |
| **跳转定义** | 标签跳转 | 点击 `@label` 跳转到定义 |
| **运行测试** | 单步执行/断点 | 调试脚本执行流程 |
| **文件浏览** | 脚本树状目录 | `script/common/`, `script/map/` 等 |

**命令分类参考（用于自动补全）：**

| 分类 | 命令数 | 示例 |
|------|:------:|------|
| NPC 命令 | 36 | `AddNpc`, `NpcGoto`, `SetNpcRelation` |
| 玩家命令 | 35 | `PlayerGoto`, `AddGoods`, `AddMagic` |
| 对话命令 | 9 | `Say`, `Talk`, `Choose`, `Select` |
| 游戏状态 | 20 | `LoadMap`, `If`, `Goto`, `Return` |
| 音频命令 | 5 | `PlayMusic`, `PlaySound`, `StopMusic` |
| 屏幕特效 | 7 | `FadeIn`, `FadeOut`, `MoveScreen` |
| 天气命令 | 3 | `BeginRain`, `EndRain`, `ShowSnow` |
| 物体命令 | 11 | `LoadObj`, `AddObj`, `OpenBox` |
| 商店/物品 | 14 | `BuyGoods`, `GetGoodsNum` |

**界面布局：**
```
┌─────────────────────────────────────────────────────────────┐
│ [文件] [编辑] [运行] [调试]                                  │
├──────────────┬──────────────────────────────┬───────────────┤
│ 📁 脚本目录   │                              │ 📋 命令列表   │
│ ├─ common/   │                              │ ├─ NPC        │
│ │  ├─ xx.txt │      代码编辑区              │ │  ├─ AddNpc  │
│ │  └─ ...    │     (Monaco Editor)          │ │  ├─ NpcGoto │
│ ├─ map/      │                              │ │  └─ ...     │
│ │  ├─ 001/   │                              │ ├─ 玩家       │
│ │  └─ ...    │                              │ └─ ...       │
│ └─ goods/    │                              │               │
├──────────────┼──────────────────────────────┼───────────────┤
│ 🐛 调试面板   │ 📝 输出/问题                                 │
│ $Event = 46  │ [信息] 脚本加载完成                          │
│ $SubEvent01=2│ [警告] 行 15: 未知命令 "Foo"                  │
└──────────────┴──────────────────────────────────────────────┘
```

---

### 3. 🧙 武功编辑器

**功能需求：**

| 模块 | 功能 | 说明 |
|------|------|------|
| **基础属性** | 名称、介绍、图标 | 武功元数据 |
| **动画预览** | 施放/飞行/消失动画 | ASF 动画实时预览 |
| **10 级数据** | 每级伤害、消耗、经验 | 表格编辑成长曲线 |
| **移动类型** | 飞行轨迹配置 | `MoveKind`: 固定/跟随/投掷/区域 等 |
| **效果测试** | 实机预览武功效果 | 在测试场景释放武功 |
| **平衡工具** | 伤害/消耗曲线图表 | 可视化对比不同武功 |

**数据格式：**
```ini
# resources/ini/magic/player-magic-烈火情天.ini
[Init]
Name=烈火情天
Intro=火焰武功...
Speed=8
MoveKind=2
Image=mag016-烈火情天.asf
Icon=mag016-烈火情天s.asf
FlyingImage=...
VanishImage=...

[Level1]
Effect=270
ManaCost=10
LevelupExp=500

[Level10]
Effect=1200
ManaCost=50
LevelupExp=50000
```

**界面布局：**
```
┌─────────────────────────────────────────────────────────────┐
│ [武功列表] 烈火情天 | 银钩铁划 | 天意剑诀 | + 新建           │
├─────────────────────┬───────────────────────────────────────┤
│                     │ 📝 基础信息                            │
│    动画预览区       │ ├─ 名称: [烈火情天        ]           │
│                     │ ├─ 介绍: [火焰武功...     ]           │
│   [▶ 播放动画]      │ ├─ 速度: [8  ] 移动类型: [跟随敌人 ▼] │
│                     │ └─ 动画: [选择 ASF...]                │
├─────────────────────┼───────────────────────────────────────┤
│ 📊 等级成长表                                                │
│ ┌───────┬────────┬──────────┬──────────┐                    │
│ │ 等级  │ 效果值 │ 法力消耗 │ 升级经验 │                    │
│ ├───────┼────────┼──────────┼──────────┤                    │
│ │ Lv.1  │  270   │   10     │   500    │                    │
│ │ Lv.2  │  350   │   15     │   800    │                    │
│ │ ...   │  ...   │   ...    │   ...    │                    │
│ │ Lv.10 │ 1200   │   50     │  50000   │                    │
│ └───────┴────────┴──────────┴──────────┘                    │
├─────────────────────────────────────────────────────────────┤
│ [保存] [测试效果] [导出]                                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 三、P1 内容编辑器

### 4. 👤 NPC/怪物编辑器

**功能需求：**

| 模块 | 功能 |
|------|------|
| **基础属性** | 名称、等级、生命、攻击、防御、闪避 |
| **AI 配置** | 类型 (Kind)、阵营 (Relation)、攻击范围、移动速度 |
| **外观绑定** | 精灵 INI、攻击动画、死亡动画、尸体物体 |
| **脚本绑定** | 对话脚本、死亡脚本、逃跑脚本 |
| **武功配置** | 普攻武功、技能武功 |
| **掉落配置** | 经验值、掉落物品列表 |
| **预览测试** | 与 NPC 战斗/对话测试 |

**数据格式：**
```ini
# resources/ini/npc/孟知秋.ini
[INIT]
Name=孟知秋
NpcIni=npc020-孟知秋.ini
FlyIni=magic-孟知秋攻击.ini
BodyIni=孟知秋尸体.ini
Kind=1
Relation=0
Life=9999
Attack=9999
Defend=9999
Evade=2000
Level=50
AttackRadius=4
WalkSpeed=1
ScriptFile=孟知秋对话.txt
```

**NPC 总数：233 个**（含剧情 NPC、路人、怪物、伙伴）

---

### 5. 🎒 物品编辑器

**功能需求：**

| 模块 | 功能 |
|------|------|
| **分类管理** | 武器、防具、饰品、草药、秘籍、剧情物品 |
| **基础属性** | 名称、介绍、价格、图标 |
| **装备属性** | 部位、攻击加成、防御加成、生命加成 |
| **消耗效果** | 恢复生命/法力/体力值 |
| **特殊效果** | 使用脚本、被动效果 |
| **图标预览** | 大图 + 小图标预览 |

**物品分类：**

| 类型 | 前缀 | 数量 |
|------|------|:----:|
| 武器 | `goods-w*` | 20 |
| 防具 | `goods-b*` | 15 |
| 头饰 | `goods-h*` | 10 |
| 鞋子 | `goods-f*` | 8 |
| 饰品 | `goods-n/r/p*` | 15 |
| 草药 | `goods-m*` | 20 |
| 秘籍 | `Book*` | 15 |
| 剧情 | `goods-e*` | 27 |

**物品总数：130 个**

---

### 6. 🏪 商店编辑器

**功能需求：**

| 模块 | 功能 |
|------|------|
| **商店列表** | 查看/新建/删除商店 |
| **商品管理** | 添加/移除商品、设置库存 |
| **物品选择** | 从物品库选择商品 |
| **分类筛选** | 按类型筛选可售物品 |

**商店总数：35 个**（按等级和类型分类）

---

### 7. 📦 场景物体编辑器

**功能需求：**

| 模块 | 功能 |
|------|------|
| **物体列表** | 宝箱、机关、草药、门、装饰等 |
| **外观配置** | 精灵 INI、朝向 |
| **交互脚本** | 绑定脚本文件 |
| **放置预览** | 在地图编辑器中预览 |

**物体总数：174 个**

---

## 四、P2 辅助编辑器

### 8. 👤 玩家/伙伴编辑器

**功能需求：**

| 模块 | 功能 |
|------|------|
| **玩家配置** | 初始属性、外观、初始武功/物品 |
| **伙伴配置** | 4 个伙伴的属性、武功、对话脚本 |
| **成长曲线** | 绑定等级配置文件 |
| **多主角** | 配置可切换的主角（驭魂术） |

**伙伴列表：**
```ini
# resources/Content/PartnerIdx.ini
1=纳兰真
2=月眉儿
3=紫轩
4=蔷薇
```

---

### 9. 📊 等级平衡编辑器

**功能需求：**

| 模块 | 功能 |
|------|------|
| **玩家成长** | 80 级成长曲线（简单/困难） |
| **NPC 成长** | NPC 等级属性表 |
| **武功经验** | 武功升级经验表 |
| **曲线图表** | 可视化成长曲线对比 |
| **平衡测试** | 模拟不同等级战斗 |

**配置文件：**
- `resources/ini/level/level-easy.ini` (80 级)
- level-hard.ini
- level-npc.ini
- MagicExp.ini

---

### 10. 🎬 精灵编辑器 (ASF Editor)

**功能需求：**

| 模块 | 功能 | 说明 |
|------|------|------|
| **动画预览** | 播放 ASF 动画、调整速度 | 支持暂停、循环、单帧步进 |
| **方向切换** | 8 方向预览 | 快捷键 1-8 切换方向 |
| **帧浏览** | 逐帧查看、帧信息 | 显示帧索引、尺寸、延迟时间 |
| **锚点编辑** | 显示/编辑 OffsetX/OffsetY | 可视化锚点位置，支持拖拽调整 |
| **调色板** | 查看/编辑调色板 | 256 色调色板预览，支持导入/导出 |
| **碰撞框** | 编辑碰撞检测区域 | 用于武功命中判定 |
| **动作标签** | 标记关键帧事件 | 攻击判定帧、音效触发帧 |
| **导出** | 导出为 GIF/PNG 序列 | 支持单方向或全方向导出 |
| **批量操作** | 批量修改帧属性 | 批量调整延迟、锚点偏移 |

**数据格式：**
```
ASF 文件结构（二进制）：
┌─────────────────────────────────────────────────┐
│ Header (32 bytes)                               │
│ ├─ Magic: "ASF\0" (4 bytes)                     │
│ ├─ Version: uint16                              │
│ ├─ FrameCount: uint16                           │
│ ├─ DirectionCount: uint8 (通常为 8)              │
│ ├─ Palette: uint8 (调色板索引)                   │
│ ├─ GlobalOffsetX: int16                         │
│ └─ GlobalOffsetY: int16                         │
├─────────────────────────────────────────────────┤
│ Frames[FrameCount * DirectionCount]             │
│ ├─ Width: uint16                                │
│ ├─ Height: uint16                               │
│ ├─ OffsetX: int16 (相对锚点偏移)                 │
│ ├─ OffsetY: int16                               │
│ ├─ Duration: uint16 (帧持续时间，毫秒)           │
│ └─ PixelData: RLE 压缩像素数据                   │
└─────────────────────────────────────────────────┘
```

**资源目录：**
```
resources/asf/
├── character/    # 角色动画 (站立/行走/跑步/攻击/受伤/死亡)
├── effect/       # 屏幕特效
├── goods/        # 物品图标 (大图 + 小图标)
├── magic/        # 武功动画 (施放/飞行/命中/消失)
├── object/       # 场景物体 (宝箱/草药/装饰)
├── portrait/     # 角色头像
└── ui/           # 界面元素
```

**界面布局：**
```
┌─────────────────────────────────────────────────────────────┐
│ [文件] [编辑] [视图] [导出]                                  │
├──────────────┬──────────────────────────────┬───────────────┤
│ 📁 资源目录   │                              │ 📋 帧属性     │
│ ├─ character │                              │ ├─ 帧索引: 3  │
│ │  ├─ npc001 │      动画预览区              │ ├─ 尺寸: 64x80│
│ │  └─ ...    │     [▶ ⏸ ◀◀ ▶▶]             │ ├─ 偏移X: -32 │
│ ├─ magic/    │                              │ ├─ 偏移Y: -60 │
│ │  ├─ mag001 │   ┌─────────────────┐        │ ├─ 延迟: 100ms│
│ │  └─ ...    │   │   ┼ (锚点显示)   │        │ └─ [应用到全部]│
│ ├─ goods/    │   │    精灵预览     │        ├───────────────┤
│ └─ ...       │   └─────────────────┘        │ 📊 方向选择   │
│              │                              │  3  4  5      │
│              │                              │  2  ●  6      │
│              │                              │  1  0  7      │
├──────────────┴──────────────────────────────┼───────────────┤
│ 📼 时间轴                                                    │
│ ┌──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┐                        │
│ │ 0│ 1│ 2│▶3│ 4│ 5│ 6│ 7│ 8│ 9│10│11│ 帧: 3/12 | 速度: 1.0x │
│ └──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┘                        │
├─────────────────────────────────────────────────────────────┤
│ 🎨 调色板预览 (256 色)                         [导入] [导出] │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │░░▓▓████░░▓▓████░░▓▓████░░▓▓████░░▓▓████░░▓▓████░░▓▓████│ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

**精灵类型统计：**

| 类型 | 目录 | 数量 | 说明 |
|------|------|:----:|------|
| 角色 | `character/` | 300+ | 包含 NPC、怪物、伙伴动画 |
| 武功 | `magic/` | 200+ | 施放、飞行、命中特效 |
| 物品 | `goods/` | 130+ | 物品大图和小图标 |
| 物体 | `object/` | 174+ | 场景交互物体 |
| 特效 | `effect/` | 100+ | 屏幕特效、天气效果 |
| 头像 | `portrait/` | 50+ | 对话头像 |
| 界面 | `ui/` | 80+ | GUI 元素 |
| **总计** | | **1000+** | |

---

### 11. 🔊 音频管理器

**功能需求：**

| 模块 | 功能 |
|------|------|
| **音乐管理** | 预览/播放背景音乐 (29 首) |
| **音效管理** | 预览/分类音效 (130+ 个) |
| **场景关联** | 查看各地图使用的音乐 |
| **音量测试** | 调整音量平衡 |

---

## 五、技术架构建议

### 编辑器技术栈

```
┌─────────────────────────────────────────────────────────────┐
│                    游戏编辑器 (React)                        │
├─────────────────────────────────────────────────────────────┤
│  UI 框架：React 19 + Tailwind CSS                           │
│  代码编辑：Monaco Editor (VSCode 同款)                       │
│  图表库：Recharts / Chart.js                                │
│  拖拽库：@dnd-kit/core                                       │
│  状态管理：Zustand                                           │
│  文件操作：File System Access API                            │
├─────────────────────────────────────────────────────────────┤
│                    @miu2d/engine                             │
│  复用：ASF 解析器、MAP 解析器、INI 解析器、渲染器             │
└─────────────────────────────────────────────────────────────┘
```

### 包结构建议

```
packages/
├── engine/          # 现有游戏引擎
├── editor-core/     # 编辑器核心（可选，共享逻辑）
├── editor/          # 编辑器主应用
│   ├── src/
│   │   ├── editors/
│   │   │   ├── MapEditor/
│   │   │   ├── ScriptEditor/
│   │   │   ├── MagicEditor/
│   │   │   ├── NpcEditor/
│   │   │   ├── GoodsEditor/
│   │   │   └── ...
│   │   ├── components/       # 共享组件
│   │   ├── hooks/            # 共享 Hooks
│   │   └── stores/           # 状态管理
│   └── package.json
└── web/             # 现有游戏前端
```

---

## 六、开发路线图

### 阶段一：基础设施（2-3 周）
- [ ] 编辑器项目骨架搭建
- [ ] INI 读写工具类
- [ ] 资源浏览器组件
- [ ] ASF 预览组件

### 阶段二：P0 编辑器（4-6 周）
- [ ] 地图编辑器（障碍/陷阱编辑）
- [ ] 脚本编辑器（语法高亮/补全）
- [ ] 武功编辑器

### 阶段三：P1 编辑器（3-4 周）
- [ ] NPC 编辑器
- [ ] 物品编辑器
- [ ] 商店编辑器
- [ ] 场景物体编辑器

### 阶段四：P2 编辑器（2-3 周）
- [ ] 玩家/伙伴编辑器
- [ ] 等级平衡编辑器
- [ ] 精灵编辑器
- [ ] 音频管理器
- [ ] 存档编辑器

---

## 七、总结

| 类别 | 编辑器数量 | 管理的资源数量 |
|------|:----------:|:--------------:|
| 地图 | 1 | 60+ 张地图 |
| 脚本 | 1 | 500+ 个脚本 |
| 武功 | 1 | 55 个武功 |
| NPC | 1 | 233 个 NPC |
| 物品 | 1 | 130 个物品 |
| 商店 | 1 | 35 个商店 |
| 物体 | 1 | 174 个物体 |
| 玩家 | 1 | 1 玩家 + 4 伙伴 |
| 等级 | 1 | 4 个配置文件 |
| 精灵 | 1 | 1000+ 个 ASF |
| 音频 | 1 | 160+ 个音频 |
| **总计** | **12** | **2000+ 资源** |

